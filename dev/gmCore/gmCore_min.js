const e=new Float64Array(3),t=new Float32Array(2).fill(100/3);export const _loop={update:()=>{},draw:()=>{}};function n(){this.axis=new Float32Array(4),this.btn=new Uint8ClampedArray(8)}export const _pad=[];for(let e=0;e<5;e++)_pad.push(new n);const o=[];let d,s=!1;const a=new Float32Array(2),i=e=>e.preventDefault(),r=e=>{_pad[0].btn[e.button]=255},c=e=>{e.preventDefault(),e.deltaY>=0?(_pad[0].btn[4]=255,o.push([0,4])):(_pad[0].btn[5]=255,o.push([0,5]))},p=e=>{if(document.pointerLockElement)return a[0]+=e.movementX/d.offsetWidth*2,a[1]+=e.movementY/d.offsetWidth*2,void _pad[0].axis.set([a[0],a[1]],2);s||_pad[0].axis.set([e.offsetX/d.offsetWidth*2-1,e.offsetY/d.offsetHeight*2-1],2)},m=e=>{_pad[0].axis[2]*=1.2,_pad[0].axis[3]*=1.2};let l;const u=()=>{d.requestPointerLock()},f=new Float32Array(4),v=e=>(e.changedTouches[0].pageX-d.offsetLeft)/d.offsetWidth*2-1,h=e=>(e.changedTouches[0].pageY-d.offsetTop)/d.offsetHeight*2-1,b=[],x={};let _=1;const w=e=>{e.cancelable&&e.preventDefault(),_=d.offsetHeight/d.offsetWidth;const t=v(e),n=h(e);((e,t,n)=>{const o=b.find((n=>!(n.x>e||n.x+n.w<e||n.y>t||n.y+n.h<t)));o&&(x[n]=o)})(t,n,e.changedTouches[0].identifier);const o=x[e.changedTouches[0].identifier];if(o)switch(o.dX=e.changedTouches[0].pageX,o.dY=e.changedTouches[0].pageY,document.body.appendChild(o.dom[1]),o.dom[1].style.top=o.dY+"px",o.dom[1].style.left=o.dX+"px",o.t){case"btn":_pad[0].btn[o.m]=255;break;case"stick":document.body.appendChild(o.dom[0]),o.dom[0].style.top=o.dY+"px",o.dom[0].style.left=o.dX+"px",o.oX=t,o.oY=n,_pad[0].axis[o.m[0]]=0,_pad[0].axis[o.m[1]]=0;break;case"swipe":o.oX=t,o.oY=n}else _pad[0].btn[3]=255,s?f.set([t,n,t,n]):_pad[0].axis.set([t,n],2)},g=e=>{e.preventDefault();const t=x[e.changedTouches[0].identifier];if(t)switch(t.t){case"stick":_pad[0].axis[t.m[0]]=5*Math.max(-.2,Math.min(v(e)-t.oX,.2)),_pad[0].axis[t.m[1]]=5*Math.max(-.2,Math.min((h(e)-t.oY)*_,.2)),t.dom[1].style.left=t.dX+16*_pad[0].axis[t.m[0]]+"px",t.dom[1].style.top=t.dY+16*_pad[0].axis[t.m[1]]+"px";break;case"swipe":_pad[0].btn[t.m[0]]=(h(e)-t.oY)*_>.1?255:0,_pad[0].btn[t.m[1]]=v(e)-t.oX>.1?255:0,_pad[0].btn[t.m[2]]=v(e)-t.oX<-.1?255:0,_pad[0].btn[t.m[3]]=(h(e)-t.oY)*_<-.1?255:0}else{if(s)return _pad[0].axis.set([2*(v(e)-f[0]),2*(h(e)-f[1])],2),void f.set([v(e),h(e)],2);_pad[0].axis.set([v(e),h(e)],2)}},E=e=>{e.cancelable&&e.preventDefault(),f.set([0,0]);const t=x[e.changedTouches[0].identifier];if(t){switch(document.body.removeChild(t.dom[1]),t.t){case"btn":_pad[0].btn[t.m]=0;break;case"stick":document.body.removeChild(t.dom[0]),_pad[0].axis[t.m[0]]=0,_pad[0].axis[t.m[1]]=0;break;case"swipe":_pad[0].btn[t.m[0]]=0,_pad[0].btn[t.m[1]]=0,_pad[0].btn[t.m[2]]=0,_pad[0].btn[t.m[3]]=0}return t.c>=0&&v(e)==t.oX&&h(e)==t.oY&&(_pad[0].btn[t.c]=255,o.push([0,t.c])),void delete x[e.changedTouches[0].identifier]}_pad[0].btn[3]=0};let L=!0;const y=[],k={KeyW:[1,"axis",1,!0],KeyA:[1,"axis",0,!0],KeyS:[1,"axis",1],KeyD:[1,"axis",0],KeyN:[1,"btn",0],KeyM:[1,"btn",1],Space:[1,"btn",2],AltLeft:[1,"btn",3],KeyQ:[1,"btn",4],KeyE:[1,"btn",5],Tab:[1,"btn",6],Enter:[1,"btn",7]},Y={F10:()=>L=!L},X=e=>{let t;for(let e=y.length-1;e>=0;e--)if(t=k[y[e]],t)switch(t[1]){case"btn":_pad[t[0]].btn[t[2]]=255;break;case"axis":_pad[t[0]].axis[t[2]]=t[3]?-1:1}},T=[null,null,null,null];let A=0;const D=e=>{if(T.findIndex((e=>null==e))>=0){for(;null!=T[A];)A=(A+1)%4;T[A]=e,console.log(`connected to slot ${A+1}`),A=(A+1)%4}else console.log("no more gamepad slots available")},K=e=>{const t=T.findIndex((t=>t==e));t>=0&&(T[t]=null)};let F=0;const C=()=>{for(const e of navigator.getGamepads())if(e){e.buttons[8].pressed&&e.buttons[9].pressed&&F<performance.now()&&(K(e.index),D(e.index),F=performance.now()+250);const t=T.findIndex((t=>t==e.index));if(t>=0){for(let n=0;n<4;n++)_pad[t+1].axis[n]=e.axes[n];for(let n=0;n<6;n++)_pad[t+1].btn[n]=e.buttons[n].pressed?255:0;for(let n=8;n<10;n++)_pad[t+1].btn[n-2]=e.buttons[n].pressed?255:0}}},M=()=>{document.pointerLockElement?(d.removeEventListener("mousewheel",c),window.addEventListener("mousewheel",c,{passive:!1})):(d.addEventListener("mousewheel",c),window.removeEventListener("mousewheel",c))};window.addEventListener("mouseup",(e=>{_pad[0].btn[e.button]=0})),document.addEventListener("pointerlockchange",M),window.addEventListener("keydown",(e=>{if(Y[e.code])return e.preventDefault(),void Y[e.code]();L&&e.preventDefault(),y.find((t=>t==e.code))||y.unshift(e.code)})),window.addEventListener("keyup",(e=>{const t=y.findIndex((t=>t==e.code));if(t>=0){e.preventDefault(),y.splice(t,1);const n=k[e.code];n&&(_pad[n[0]][n[1]][n[2]]=0)}})),window.addEventListener("gamepadconnected",(e=>{console.log(e.gamepad.buttons[0]),console.log(`${e.gamepad.id} detected.`),D(e.gamepad.index)})),window.addEventListener("gamepaddisconnected",(e=>{K((t=>t==e.gamepad.index)),console.log(`${e.gamepad.id} disconnected.`,T)}));const W=()=>{for(let e=o.length;e>0;e--){const e=o.pop();_pad[e[0]].btn[e[1]]=0}s&&(a.set([0,0]),f.set([f[2],f[3]]),_pad[0].axis.set([0,0],2))},I=()=>{for(e[2]=performance.now();e[0]<e[2];)C(),X(),_loop.update(),W(),e[0]+=t[0];if(e[1]<e[2])for(_loop.draw();e[1]<e[2];)e[1]+=t[1];setTimeout(I)};I();const H=()=>{const e=[document.createElement("div"),document.createElement("div")];return e[0].style="transform:translate(-10vmin,-10vmin);z-index:99;user-select:none;position:fixed;width:20vmin;height:20vmin;border-radius:50%;background:#5552;",e[1].style="transform:translate(-5vmin,-5vmin);z-index:100;user-select:none;position:fixed;width:10vmin;height:10vmin;border-radius:50%;background:#5552;",e};export const _cfg={setClock:e=>{t[0]=1e3/e},setFps:e=>{t[1]=1e3/e},pointerTarget:e=>{(e=>{d&&(d.removeEventListener("mousewheel",c),d.removeEventListener("mouseleave",m),d.removeEventListener("mousemove",p),d.removeEventListener("contextmenu",i),d.removeEventListener("mousedown",r),d.removeEventListener("touchstart",w),d.removeEventListener("touchmove",g),d.removeEventListener("touchend",E),d.removeEventListener("touchcancel",E)),d=e,M(),e.addEventListener("mouseleave",m),e.addEventListener("mousemove",p),e.addEventListener("contextmenu",i),e.addEventListener("mousedown",r),e.addEventListener("touchstart",w),e.addEventListener("touchmove",g),e.addEventListener("touchend",E),e.addEventListener("touchcancel",E)})(e)},pointerLock:e=>{s=!!e,e?(l&&l.removeEventListener("click",u),l=d,d.addEventListener("click",u)):(l&&l.removeEventListener("click",u),document.exitPointerLock())},tpAdd:(e,t,n,o,d,s,a)=>{b.push({x:e,y:t,w:n,h:o,t:d,m:s,c:a,dom:H(),dX:0,dY:0,oX:0,oY:0})},tpRemove:(e,t)=>{const n=b.findIndex((n=>n.x===e&&n.y===t));n>=0&&b.splice(n,1)},getKbMap:()=>k,kbAdd:(...e)=>{e.forEach((e=>{k[e.key]=e.map}))},kbRemove:(...e)=>{e.forEach((e=>{delete k[e]}))}};